<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Regular expressions highlighter</title>
    <link href="regExpHighlighter.css" rel="stylesheet" type="text/css" />
    <script type="application/javascript;version=1.8" src="tokenizer.js"></script>
    <script type="application/javascript;version=1.8" src="regExpHighlighter.js"></script>
    <script type="application/javascript;version=1.8">
    function tokenize(regExp) {
      tokenizedRegExp = tokenizer.tokenize(regExp);
      console.log(tokenizedRegExp);
      return tokenizedRegExp;
    }

    function getSelectionOffset() {
      var selectionRange = window.getSelection();

      var parent = selectionRange.anchorNode;
      while (parent !== document.documentElement && parent.id !== "regExp") {
        parent = parent.parentElement;
      }

      if (parent === document.documentElement) {
        return 0;
      }

      var offset = selectionRange.anchorOffset;

      var node = selectionRange.anchorNode;
      while(node && node.id !== "regExp") {
        if (node.previousSibling) {
          node = node.previousSibling;
          offset += node.textContent.length;
        } else {
          node = node.parentElement;
        }
      }

      return offset;
    }

    function getRangeByOffset(offset) {
      var node = document.getElementById("regExp");
      var anchorOffset = offset;
      while (node) {
        var contentLength = node.textContent.length;
        if (contentLength < anchorOffset) {
          anchorOffset -= contentLength;
          if (!node.nextElementSibling) {
            break;
          }
          node = node.nextElementSibling;
        } else {
          if (!node.firstElementChild) {
            break;
          }
          node = node.firstElementChild;
        }
      }

      if (node.firstChild) {
        node = node.firstChild;
      }

      var range = document.createRange();
      range.setStart(node, anchorOffset);
      range.setEnd(node, anchorOffset);

      return range;
    }

    function highlight() {
      var regExpField = document.getElementById("regExp");
      var regExp = tokenize(regExpField.textContent);

      var selectionOffset = getSelectionOffset();
      regExpField.textContent = "";
      regExpField.appendChild(highlighter.highlight(regExp));
      var selection = window.getSelection();
      selection.removeAllRanges();
      var range = getRangeByOffset(selectionOffset);
      selection.addRange(range);
    }

    var tokenizer = new RegExpTokenizer();
    var highlighter = new RegExpHighlighter();

    window.addEventListener("DOMContentLoaded", function onLoad() {
      var regExp = document.getElementById("regExp");
      regExp.contentEditable = true;

      highlight();

      var regExpField = document.getElementById("regExp");
      regExpField.addEventListener("input", function onRegExpFieldKeyDown(evt) {
        var ignoredKeyCodes = new Set([
          KeyEvent.DOM_VK_LEFT,
          KeyEvent.DOM_VK_RIGHT,
          KeyEvent.DOM_VK_UP,
          KeyEvent.DOM_VK_DOWN,
          KeyEvent.DOM_VK_CONTROL,
          KeyEvent.DOM_VK_ALT,
          KeyEvent.DOM_VK_ALTGR,
          KeyEvent.DOM_VK_META,
          KeyEvent.DOM_VK_SHIFT,
          KeyEvent.DOM_VK_CAPS_LOCK,
          KeyEvent.DOM_VK_TAB,
          KeyEvent.DOM_VK_RETURN,
          KeyEvent.DOM_VK_CONTEXT_MENU,
          KeyEvent.DOM_VK_ESCAPE,
          KeyEvent.DOM_VK_HOME,
          KeyEvent.DOM_VK_END,
          KeyEvent.DOM_VK_PAGE_UP,
          KeyEvent.DOM_VK_PAGE_DOWN,
          KeyEvent.DOM_VK_NUM_LOCK,
          KeyEvent.DOM_VK_PAUSE,
          KeyEvent.DOM_VK_PRINTSCREEN
        ]);

        if (!ignoredKeyCodes.has(evt.keyCode)) {
          highlight();
        }
      });

      function highlightGroup() {
        var highlightedGroup = document.getElementsByClassName("highlighted");
        if (highlightedGroup.length > 0) {
          highlightedGroup[0].classList.remove("highlighted");
        }

        var selection = window.getSelection();
        var selectedElement = selection.anchorNode.parentElement;
        var highlightedGroup = null;
        if (selectedElement.classList.contains("bracket") && selection.anchorOffset === 1) {
          highlightedGroup = selectedElement.parentElement;
        } else if (selectedElement.previousElementSibling &&
            selectedElement.previousElementSibling.classList.contains("group") &&
            selection.anchorOffset === 0) {
          highlightedGroup = selectedElement.previousElementSibling;
        } else if (selection.anchorOffset === 0 && !selectedElement.classList.contains("Range")) {
          var element = selectedElement;
          while (!element.previousElementSibling &&
              (element.parentElement.classList.contains("Alternation") ||
                  element.parentElement.classList.contains("Range"))) {
            element = element.parentElement;
          }

          if (element.previousElementSibling && element.previousElementSibling.classList.contains("bracket")) {
            highlightedGroup = element.parentElement;
          }
        }

        if (highlightedGroup) {
          highlightedGroup.classList.add("highlighted");
        }
      }

      regExpField.addEventListener("mouseup", highlightGroup);
      regExpField.addEventListener("keyup", function onRegExpFieldKeyUp(evt) {
        var navigationKeys = new Set([
          KeyEvent.DOM_VK_LEFT,
          KeyEvent.DOM_VK_RIGHT,
          KeyEvent.DOM_VK_UP,
          KeyEvent.DOM_VK_DOWN,
          KeyEvent.DOM_VK_PAGE_UP,
          KeyEvent.DOM_VK_PAGE_DOWN,
          KeyEvent.DOM_VK_HOME,
          KeyEvent.DOM_VK_END
        ]);

        if (navigationKeys.has(evt.keyCode)) {
          highlightGroup();
        }
      });
    });
    </script>
  </head>
  <body>
    <div id="regExp">a(b|c)</div>
  </body>
</html>